-- Olist’te ortalama sipariş teslimat süresi nedir?

--temizlik

-- Remove duplicate rows from the orders table
CREATE OR REPLACE TABLE `OLIST.olist_orders_dataset_fixed` AS
SELECT * FROM `OLIST.olist_orders_dataset`;


DELETE FROM `OLIST.olist_orders_dataset_fixed` T
WHERE T.order_id IN (
  SELECT order_id
  FROM (
    SELECT order_id
    FROM `OLIST.olist_orders_dataset_fixed`
    GROUP BY order_id
    HAVING COUNT(*) > 1
  )
);

select 
customer_id
,order_status
,order_purchase_timestamp
,order_approved_at
,order_delivered_carrier_date
,order_delivered_customer_date
,order_estimated_delivery_date

FROM `OLIST.olist_orders_dataset_fixed` 

DELETE FROM `OLIST.olist_orders_dataset_fixed`
WHERE customer_id IS NULL
   OR order_status IS NULL
   OR order_purchase_timestamp IS NULL
   OR order_approved_at IS NULL
   OR order_delivered_carrier_date IS NULL
   OR order_delivered_customer_date IS NULL
   OR order_estimated_delivery_date IS NULL;
 -- sonuç 
SELECT
  
    round(AVG(DATE_DIFF(order_delivered_customer_date, order_approved_at, DAY)),2)
    
   AS average_delivery_time
FROM `OLIST.olist_orders_dataset_fixed` 

--Belirli satıcılar veya bölgeler teslimat gecikmeleri yaşıyor mu?

--temizlik

-- Remove duplicate rows from the orders table
CREATE OR REPLACE TABLE `OLIST.olist_sellers_dataset_fixed` AS
SELECT * FROM `OLIST.olist_sellers_dataset`;


DELETE FROM `OLIST.olist_sellers_dataset_fixed` T
WHERE T.seller_id IN (
  SELECT seller_id
  FROM (
    SELECT seller_id
    FROM `OLIST.olist_sellers_dataset_fixed`
    GROUP BY seller_id
    HAVING COUNT(*) > 1
  )
);
-- Remove duplicate rows from the orders table
CREATE OR REPLACE TABLE `OLIST.olist_customers_dataset_fixed` AS
SELECT * FROM `OLIST.olist_customers_dataset`;


DELETE FROM `OLIST.olist_customers_dataset_fixed` T
WHERE T.customer_id IN (
  SELECT customer_id
  FROM (
    SELECT customer_id
    FROM `OLIST.olist_customers_dataset_fixed`
    GROUP BY customer_id
    HAVING COUNT(*) > 1
  )
);
--sonuç
select 
s.seller_id as sellers,
c.customer_city,
o.order_estimated_delivery_date as estimated_date, 
o.order_delivered_carrier_date as delivered_date,
date_diff(o.order_delivered_customer_date,o.order_estimated_delivery_date,DAY) as delivery_time,

from `OLIST.olist_customers_dataset_fixed` c join `OLIST.olist_orders_dataset_fixed` o on c.customer_id=o.customer_id
join `OLIST.olist_order_items_dataset_fixed` oi on o.order_id=oi.order_id
join `OLIST.olist_sellers_dataset_fixed` s on oi.seller_id=s.seller_id

group by s.seller_id,o.order_estimated_delivery_date, o.order_delivered_carrier_date,date_diff(o.order_delivered_customer_date,o.order_estimated_delivery_date,DAY),c.customer_city
order by delivery_time desc


SELECT
  ge.geolocation_state AS state,
  c.customer_city AS city,
  AVG(DATE_DIFF(o.order_delivered_customer_date, o.order_estimated_delivery_date, DAY)) AS avg_delivery_delay,
  COUNT(*) AS total_orders
FROM `OLIST.olist_customers_dataset_fixed` c
JOIN `OLIST.olist_orders_dataset_fixed` o ON c.customer_id = o.customer_id
JOIN `OLIST.olist_order_items_dataset_fixed` oi ON o.order_id = oi.order_id
JOIN `OLIST.olist_sellers_dataset_fixed` s ON oi.seller_id = s.seller_id
JOIN `OLIST.olist_geolocation_dataset` ge ON c.customer_zip_code_prefix = ge.geolocation_zip_code_prefix
WHERE o.order_delivered_customer_date IS NOT NULL
  AND o.order_estimated_delivery_date IS NOT NULL
GROUP BY ge.geolocation_state, c.customer_city
ORDER BY avg_delivery_delay DESC

SELECT
  ge.geolocation_state AS state,
  c.customer_city AS city,
  COUNT(*) AS delayed_orders
FROM `OLIST.olist_customers_dataset_fixed` c
JOIN `OLIST.olist_orders_dataset_fixed` o ON c.customer_id = o.customer_id
JOIN `OLIST.olist_order_items_dataset_fixed` oi ON o.order_id = oi.order_id
JOIN `OLIST.olist_sellers_dataset_fixed` s ON oi.seller_id = s.seller_id
JOIN `OLIST.olist_geolocation_dataset` ge ON c.customer_zip_code_prefix = ge.geolocation_zip_code_prefix
WHERE o.order_delivered_customer_date IS NOT NULL
  AND o.order_estimated_delivery_date IS NOT NULL
  AND DATE_DIFF(o.order_delivered_customer_date, o.order_estimated_delivery_date, DAY) > 0
GROUP BY ge.geolocation_state, c.customer_city
ORDER BY delayed_orders DESC

select * from `OLIST.olist_geolocation_dataset` limit 10
/*  Yapay zeka önerisi: 
SELECT
  s.seller_id AS seller,
  c.customer_city,
  
  -- Ortalama teslimat gecikmesi (gün cinsinden)
  AVG(DATE_DIFF(o.order_delivered_customer_date, o.order_estimated_delivery_date, DAY)) AS avg_delivery_delay,
  
  -- Toplam sipariş sayısı
  COUNT(*) AS total_orders,
  
  -- Tahminin dışında geciken sipariş sayısı (delivery_time > 0)
  COUNTIF(DATE_DIFF(o.order_delivered_customer_date, o.order_estimated_delivery_date, DAY) > 0) AS delayed_orders,
  
  -- Gecikme oranı
  ROUND(
    COUNTIF(DATE_DIFF(o.order_delivered_customer_date, o.order_estimated_delivery_date, DAY) > 0) * 100.0 / COUNT(*),
    2
  ) AS delay_percentage
FROM `OLIST.olist_orders_dataset` o
JOIN `OLIST.olist_order_items_dataset` oi ON o.order_id = oi.order_id
JOIN `OLIST.olist_customers_dataset` c ON o.customer_id = c.customer_id
JOIN `OLIST.olist_sellers_dataset` s ON oi.seller_id = s.seller_id
WHERE o.order_delivered_customer_date IS NOT NULL
  AND o.order_estimated_delivery_date IS NOT NULL
GROUP BY s.seller_id, c.customer_city
ORDER BY avg_delivery_delay DESC;
*/

--Sipariş durumu müşteri memnuniyetini nasıl etkiliyor?

--sonuç
select 

order_status as status,
coalesce(cast(order_delivered_customer_date as string), 'unknown') as delivered_date, 
coalesce(cast(date_diff(order_delivered_customer_date,order_estimated_delivery_date,DAY) as string), 'unknown') as delivery_time

from `OLIST.olist_orders_dataset_fixed` 
group by order_status,date_diff(order_delivered_customer_date,order_estimated_delivery_date,DAY)
order by delivery_time desc 


SELECT 
  o.order_status AS siparis_durumu,
  ROUND(AVG(DATE_DIFF(o.order_delivered_customer_date, o.order_estimated_delivery_date, DAY)), 2) AS ortalama_teslimat_farki,
  ROUND(AVG(r.review_score), 2) AS ortalama_memnuniyet_puani,
  COUNT(r.review_id) AS yorum_sayisi
FROM `OLIST.olist_orders_dataset_fixed` o
LEFT JOIN `OLIST.olist_order_reviews_dataset_fixed` r ON o.order_id = r.order_id
WHERE o.order_delivered_customer_date IS NOT NULL
GROUP BY o.order_status
ORDER BY ortalama_memnuniyet_puani DESC


SELECT
  
    round(AVG(DATE_DIFF(order_delivered_customer_date, order_estimated_delivery_date, DAY)),2)
    
   AS average_delivery_time
FROM `OLIST.olist_orders_dataset_fixed` 

select 

order_status as status,
coalesce(cast(order_delivered_customer_date as string), 'unknown') as delivered_date, 
coalesce(cast(date_diff(order_delivered_customer_date,order_estimated_delivery_date,DAY) as string), 'unknown') as delivery_time

from `OLIST.olist_orders_dataset_fixed` 
group by order_status,date_diff(order_delivered_customer_date,order_estimated_delivery_date,DAY)
order by delivery_time desc 

