-- Olist’te ortalama sipariş teslimat süresi nedir?

SELECT
  
    round(AVG(DATE_DIFF(order_delivered_customer_date, order_estimated_delivery_date, DAY)),2)
    
   AS average_delivery_time
FROM `OLIST.olist_orders_dataset` 

--Belirli satıcılar veya bölgeler teslimat gecikmeleri yaşıyor mu?

select 
s.seller_id as sellers,
c.customer_city,
o.order_estimated_delivery_date as estimated_date, 
o.order_delivered_carrier_date as delivered_date,
date_diff(o.order_delivered_customer_date,o.order_estimated_delivery_date,DAY) as delivery_time,


from `OLIST.olist_customers_dataset` c join `OLIST.olist_orders_dataset` o on c.customer_id=o.customer_id
join `OLIST.olist_order_items_dataset` oi on o.order_id=oi.order_id
join `OLIST.olist_sellers_dataset` s on oi.seller_id=s.seller_id

group by s.seller_id,o.order_estimated_delivery_date, o.order_delivered_carrier_date,date_diff(o.order_delivered_customer_date,o.order_estimated_delivery_date,DAY),c.customer_city
order by delivery_time desc
/*  Yapay zeka önerisi: 
SELECT
  s.seller_id AS seller,
  c.customer_city,
  
  -- Ortalama teslimat gecikmesi (gün cinsinden)
  AVG(DATE_DIFF(o.order_delivered_customer_date, o.order_estimated_delivery_date, DAY)) AS avg_delivery_delay,
  
  -- Toplam sipariş sayısı
  COUNT(*) AS total_orders,
  
  -- Tahminin dışında geciken sipariş sayısı (delivery_time > 0)
  COUNTIF(DATE_DIFF(o.order_delivered_customer_date, o.order_estimated_delivery_date, DAY) > 0) AS delayed_orders,
  
  -- Gecikme oranı
  ROUND(
    COUNTIF(DATE_DIFF(o.order_delivered_customer_date, o.order_estimated_delivery_date, DAY) > 0) * 100.0 / COUNT(*),
    2
  ) AS delay_percentage
FROM `OLIST.olist_orders_dataset` o
JOIN `OLIST.olist_order_items_dataset` oi ON o.order_id = oi.order_id
JOIN `OLIST.olist_customers_dataset` c ON o.customer_id = c.customer_id
JOIN `OLIST.olist_sellers_dataset` s ON oi.seller_id = s.seller_id
WHERE o.order_delivered_customer_date IS NOT NULL
  AND o.order_estimated_delivery_date IS NOT NULL
GROUP BY s.seller_id, c.customer_city
ORDER BY avg_delivery_delay DESC;
*/

--Sipariş durumu müşteri memnuniyetini nasıl etkiliyor?
select 

order_status as status,
coalesce(cast(order_delivered_customer_date as string), 'unknown') as delivered_date, 
coalesce(cast(date_diff(order_delivered_customer_date,order_estimated_delivery_date,DAY) as string), 'unknown') as delivery_time

from `OLIST.olist_orders_dataset` 
group by order_status,date_diff(order_delivered_customer_date,order_estimated_delivery_date,DAY)
order by delivery_time desc 

